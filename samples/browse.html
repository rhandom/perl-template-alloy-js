<html>
<head>
<title>Browser based usage</title>
<style>
h3 { margin-bottom: 2px }
</style>
</head>
<body>
<h3>Template/Alloy/alloy.js</h3>
<div>
Template/Alloy/alloy.js is not designed for use in a browser.  If you want to do templating in a browser, look at jemplate.

That being said, we can use alloy.js in a browser if we are willing to undergo a little pain.  The main practical purpose for this
is to test various vms, and use the native browser tools for optimizing javascript.

This file has been tested on Chrome and Firefox.  It will likely break on IE.
</div>

<script src="../lib/Template/Alloy/vmethods.js"></script>

<script>
$_UNITTEST = 1;
$_call_native = function (method) {
  if (method === 'load_js') {
    var mod = arguments[1];
    if (mod === 'vmethods') {
      var t = 'var $_vmethods = {\n';
      for (var type in $_vmethods) {
        t += type+':{\n';
        for (var m in $_vmethods[type]) t += "'"+m+"':"+$_vmethods[type][m]+",\n";
        t += '},\n';
      }
      t += '};\n';
      return t;
    }
    alert("Need to load module "+mod);
  } else {
    alert("Got an unhandled native method call "+method);
  }
}
</script>

<script src="../lib/Template/Alloy/alloy.js"></script>

<script>
alloy.register_template('list.tt', (function () {
// Generated by Template::Alloy::JS v1.000 on Mon Feb 20 11:15:28 2012
// From file /home/paul/dev/Template-Alloy-JS/samples/template/list.tt

var blocks = {};
var meta   = {};
var code   = function (alloy, out_ref) {

  out_ref[0] += "List:\n";

  // "FOREACH" Line 2 char 2 (chars 8 to 29)
  var $_v = alloy.vars();
  var old_loop1 = $_v.loop;
  var err;
  try {
  var loop1 = alloy.get(["data",0]);
  if (loop1 == null) loop1 = [];
  if (!loop1.get_first) loop1 = new alloy.iterator(loop1);
  $_v.loop = loop1;
  ref = loop1.get_first();
  var val = ref[0];
  var error = ref[1];
  while (!error) {
    alloy.set(["item",0], val);

    out_ref[0] += "    * ";

    // "GET" Line 3 char 8 (chars 42 to 81)
    out_ref[0] += (alloy.get(["item",0,'.',"title",0])?alloy.get(["item",0,'.',"title",0,'.',"html",[]]):"foo");

    out_ref[0] += "\n    * ";

    // "GET" Line 4 char 8 (chars 93 to 127)
    out_ref[0] += (alloy.get(["item",0,'.',"author",0,'.',"html",[]])||"no author");

    out_ref[0] += "\n    * ";

    // "GET" Line 5 char 8 (chars 139 to 167)
    out_ref[0] += (alloy.get(["item",0,'.',"abstract",0,'.',"html",[]])||"-");

    out_ref[0] += "\n";

    // "END" Line 6 char 2 (chars 173 to 178)
    ref = loop1.get_next();
    val   = ref[0];
    error = ref[1];
    }
  } catch (e) { err = e }
  $_v.loop = old_loop1;
  if (err != null) throw err;
};

return {
  name: "list.tt",
  blocks: blocks,
  meta: meta,
  code: code
};
})());

alloy.register_template('include.tt', (function () {
// Generated by Template::Alloy::JS v1.000 on Mon Feb 20 12:36:58 2012
// From file /home/paul/dev/Template-Alloy-JS/samples/template/include.tt

var blocks = {};
var meta   = {};
var code   = function (alloy, out_ref) {

  out_ref[0] += "Include:\n";

  // "INCLUDE" Line 2 char 2 (chars 11 to 30)
  alloy.process_d_i(["list.tt"],[],'INCLUDE', out_ref);

};

return {
  name: "include.tt",
  blocks: blocks,
  meta: meta,
  code: code
};
})());

</script>

<h3>Loaded documents</h3>
<script>
var say = function (m) { document.write(''+m+"\n") };
var docs = alloy._docs(); // available via $_UNITTEST=1
for (var n in docs) say(n+"<br>");
alloy.load_vm();

function run () {
  var f = document.getElementById('file');
  var n = document.getElementById('rows');
  var l = document.getElementById('loops');
  var o = document.getElementById('out');
  var t = document.getElementById('time');
  $_env = {};
  $_vars = {data:[]};
  for (var i = 0; i < n.value; i++) $_vars.data.push({title:'Title'+i,author:'Author'+i, abstract:'Abstract'+i});
  o.innerHTML = 'Running<blink>...</blink>';
  var max = parseInt(l.value);
  var begin = new Date();
  begin = begin.getTime();
  for (var i = 0; i < max; i++) {
    var out_ref = [''];
    var out = alloy.process(f[f.selectedIndex].text, out_ref, 1);
    if (i == max-1) o.innerHTML = out[0].replace(/</g, '&lt;');
  }
  var end = new Date();
  end = end.getTime();
  var diff = (end - begin)/1000;
  var per  = max / (diff || 1);
  t.innerHTML = '('+max+' run'+(max==1?'':'s')+', '+(''+diff).replace(/(\.\d\d\d)\d+/, '$1')+' seconds, '+(''+per).replace(/(\.\d\d\d)\d+/, '$1')+' per second)';
}

</script>


<h3>Trial Run</h3>
File: <select id="file"><script>for (var n in docs) say("<option>"+n+"</option>")</script></select><br>
Data Rows: <input type="text" id="rows" value="10" size="5"><br>
Loops: <input type="text" id="loops" value="100" size="5"><input type="button" value="Run" onclick="run()"><br>
Output: <span id="time"></span><pre id="out" style="color:darkgreen"></pre>

</body>
</html>
